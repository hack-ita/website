{{/* ================================
   CONTEXT-AWARE TAXONOMY FILTERS
================================ */}}

{{ $site := .Site }}
{{ $kind := .Kind }}
{{ $taxonomy := .Data.Plural | default "" }}

{{/* MODE DETECTION */}}
{{ $mode := "blog" }}
{{ if eq $kind "term" }}
  {{ if eq $taxonomy "categories" }}
    {{ $mode = "category-term" }}
  {{ else if eq $taxonomy "tags" }}
    {{ $mode = "tag-term" }}
  {{ end }}
{{ end }}

<div class="flex flex-col gap-5 lg:flex-row lg:justify-between lg:items-center mb-10">
  <h4 class="heading-sm text-dark dark:text-light">Filters</h4>

  <div
    id="taxonomyFilters"
    class="flex flex-wrap gap-4 items-end"
    data-filter-mode="{{ $mode }}"
    {{ if eq $mode "category-term" }}
      data-current-category="{{ .Title | urlize }}"
    {{ end }}
  >

    {{/* CATEGORY FILTER */}}
    {{ if or (eq $mode "blog") (eq $mode "tag-term") }}
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium uppercase text-dark dark:text-light">
        Category
      </label>
      <select
        id="filter-category"
        class="taxonomy-select min-w-40 rounded-md border border-primary
               bg-white dark:bg-accent
               py-2 px-3 text-sm uppercase
               text-dark dark:text-light
               focus:outline-none focus:ring-2 focus:ring-primary transition">
        <option value="all">ALL</option>
        {{ range $site.Taxonomies.categories }}
          <option value="{{ .Page.Title | urlize }}">
            {{ .Page.Title }}
          </option>
        {{ end }}
      </select>
    </div>
    {{ end }}

    {{/* TAG / SUB-CATEGORY FILTER */}}
    {{ if or (eq $mode "blog") (eq $mode "category-term") }}
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium uppercase text-dark dark:text-light">
        Sub-category
      </label>
      <select
        id="filter-tag"
        disabled
        class="taxonomy-select min-w-40 rounded-md border border-primary
               bg-white dark:bg-accent
               py-2 px-3 text-sm uppercase
               text-dark dark:text-light
               opacity-60 cursor-not-allowed
               focus:outline-none focus:ring-2 focus:ring-primary transition">
        <option>SELEZIONA CATEGORIA</option>
      </select>
    </div>
    {{ end }}

    <button
      type="button"
      class="clear-filters text-sm font-medium text-primary hover:underline transition uppercase">
      Clear all
    </button>

  </div>
</div>

{{/* CATEGORY â†’ TAG MAP (BLOG + CATEGORY TERM) */}}
{{ if or (eq $mode "blog") (eq $mode "category-term") }}
<script type="application/json" id="categoryTagMap">
{{ $map := dict }}
{{ range $term, $termPages := $site.Taxonomies.categories }}
  {{ $tags := slice }}
  {{ range $termPages.Pages }}
    {{ range .Params.tags }}
      {{ $tags = $tags | append (dict
          "label" .
          "value" (. | urlize)
      ) }}
    {{ end }}
  {{ end }}
  {{ $map = merge $map (dict ($term | urlize) ($tags | uniq)) }}
{{ end }}
{{ $map | jsonify | safeJS }}
</script>
{{ end }}