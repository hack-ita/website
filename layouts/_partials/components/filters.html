{{/* =====================================
   TAXONOMY FILTERS (CATEGORY + SUBCATEGORY)
   Source of truth:
   - Categories  â†’ .Site.Taxonomies.categories
   - Subcategories â†’ category _index.md (subcategories)
===================================== */}}

{{ $site := .Site }}

<div class="flex flex-col gap-5 lg:flex-row lg:justify-between lg:items-center mb-10">
  <h4 class="heading-sm text-dark dark:text-light">Filtri</h4>

  <div
    id="taxonomyFilters"
    class="flex flex-wrap gap-4 items-end"
  >

    {{/* CATEGORY FILTER */}}
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium uppercase text-dark dark:text-light">
        Categoria
      </label>
      <select
        id="filter-category"
        class="taxonomy-select min-w-40 rounded-md border border-primary
               bg-white dark:bg-accent
               py-2 px-3 text-sm uppercase
               text-dark dark:text-light
               focus:outline-none focus:ring-2 focus:ring-primary transition">
        <option value="all">TUTTE</option>
        {{ range $site.Taxonomies.categories }}
          <option value="{{ .Page.Title | urlize }}">
            {{ .Page.Title }}
          </option>
        {{ end }}
      </select>
    </div>

    {{/* SUBCATEGORY FILTER */}}
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium uppercase text-dark dark:text-light">
        Sottocategoria
      </label>
      <select
        id="filter-subcategory"
        disabled
        class="taxonomy-select min-w-40 rounded-md border border-primary
               bg-white dark:bg-accent
               py-2 px-3 text-sm uppercase
               text-dark dark:text-light
               opacity-60 cursor-not-allowed
               focus:outline-none focus:ring-2 focus:ring-primary transition">
        <option>SELEZIONA CATEGORIA</option>
      </select>
    </div>

    <button
      type="button"
      class="text-sm font-medium text-primary hover:underline transition uppercase clear-filters">
      Azzera filtri
    </button>

  </div>
</div>

{{/* =====================================
   CATEGORY â†’ SUBCATEGORY MAP
===================================== */}}
<script type="application/json" id="categorySubcategoryMap">
{
{{- $first := true -}}
{{- range $term, $termPages := $site.Taxonomies.categories -}}
  {{- $catPage := $termPages.Page -}}
  {{- if not $first }},{{ end -}}
  "{{ $term | urlize }}": [
    {{- with $catPage.Params.subcategories -}}
      {{- range $i, $sc := . -}}
        {{- if $i }},{{ end -}}
        {
          "label": "{{ $sc }}",
          "value": "{{ $sc | urlize }}"
        }
      {{- end -}}
    {{- end -}}
  ]
  {{- $first = false -}}
{{- end -}}
}
</script>

{{/* =====================================
   FILTER LOGIC (INLINE JS)
===================================== */}}
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.group("ðŸ§ª FILTERS DEBUG INIT");

  const catSelect = document.querySelector("#filter-category");
  const subSelect = document.querySelector("#filter-subcategory");
  const clearButtons = document.querySelectorAll(".clear-filters");
  const posts = [...document.querySelectorAll(".post-item")];
  const mapEl = document.querySelector("#categorySubcategoryMap");
  const noRes = document.querySelector("#noResults");

  if (!catSelect || !subSelect || !mapEl) return;

  const map = JSON.parse(mapEl.textContent);

  const normalize = raw =>
    raw.split(",").map(v => v.trim().toLowerCase()).filter(Boolean);

  const applyFilters = () => {
    const selectedCat = catSelect.value.toLowerCase();
    const selectedSub = subSelect.value.toLowerCase();
    let visible = 0;

    posts.forEach(post => {
      const cats = normalize(post.dataset.categories || "");
      const subs = normalize(post.dataset.tags || "");
      let show = true;

      if (selectedCat !== "all" && !cats.includes(selectedCat)) show = false;
      if (!subSelect.disabled && selectedSub !== "all" && !subs.includes(selectedSub)) show = false;

      post.style.display = show ? "" : "none";
      if (show) visible++;
    });

    const groups = document.querySelectorAll(".category-group");
    groups.forEach(group => {
      const hasVisible = group.querySelector(".post-item:not([style*='display: none'])");
      group.style.display = hasVisible ? "" : "none";
    });

    noRes?.classList.toggle("hidden", visible > 0);
  };

  const populateSubcategories = category => {
    subSelect.innerHTML = `<option value="all">TUTTE</option>`;
    (map[category] || []).forEach(sc => {
      const opt = document.createElement("option");
      opt.value = sc.value;
      opt.textContent = sc.label;
      subSelect.appendChild(opt);
    });
    subSelect.disabled = false;
    subSelect.classList.remove("opacity-60", "cursor-not-allowed");
  };

  catSelect.addEventListener("change", () => {
    const value = catSelect.value.toLowerCase();
    if (value === "all") {
      subSelect.disabled = true;
      subSelect.innerHTML = `<option>SELEZIONA CATEGORIA</option>`;
      subSelect.classList.add("opacity-60", "cursor-not-allowed");
    } else {
      populateSubcategories(value);
    }
    applyFilters();
  });

  subSelect.addEventListener("change", applyFilters);

  clearButtons.forEach(btn =>
    btn.addEventListener("click", () => {
      catSelect.value = "all";
      subSelect.disabled = true;
      subSelect.innerHTML = `<option>SELEZIONA CATEGORIA</option>`;
      subSelect.classList.add("opacity-60", "cursor-not-allowed");
      applyFilters();
    })
  );
});
</script>